<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title data-i18n="manageUsers">Manage Users</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" type="image/png" href="logo.png" />
  <script src="header.js"></script>
  <script src="utils/notifications.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
<script>
if (!localStorage.getItem('token')) {
  window.location.href = 'index.html';
}
</script>
<div id="header"></div>
<div class="container mt-3">
  <h2 data-i18n="manageUsers">Manage Users</h2>
  <div class="panel form-section mb-3">
    <form id="userForm" class="row g-2 align-items-end" autocomplete="off">
      <div class="col-md-3">
        <input type="text" id="newUsername" class="form-control" placeholder="Login" required />
      </div>
      <div class="col-md-3">
        <input type="password" id="newPassword" class="form-control" placeholder="Password" required />
      </div>
      <div class="col-md-3">
        <select id="userDept" class="form-select"></select>
      </div>
      <div class="col-md-2">
        <select id="userRole" class="form-select">
          <option value="user">User</option>
          <option value="admin">Admin</option>
          <option value="superuser">Superuser</option>
        </select>
      </div>
      <div class="col-md-1">
        <button type="submit" class="btn btn-primary w-100">Add</button>
      </div>
    </form>
  </div>
  <div class="table-responsive">
    <table id="usersTable" class="table table-bordered table-sm">
      <thead>
        <tr><th>Name</th><th>Email</th><th data-i18n="department">Department</th><th>Role</th><th>Edit</th><th>Delete</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div class="mt-3">
    <h3 data-i18n="edit">Edit</h3>
    <form id="editForm" class="row g-2" autocomplete="off">
      <div class="col-md-3"><input type="text" id="editName" class="form-control" required /></div>
      <div class="col-md-3"><input type="email" id="editEmail" class="form-control" /></div>
      <div class="col-md-2"><select id="editDept" class="form-select"></select></div>
      <div class="col-md-2"><select id="editRole" class="form-select"><option value="user">user</option><option value="admin">admin</option><option value="superuser">superuser</option></select></div>
      <div class="col-md-2"><input type="password" id="editPassword" class="form-control" placeholder="Password" /></div>
      <div class="col-12"><button type="submit" class="btn btn-primary" data-i18n="save">Save</button></div>
    </form>
  </div>
</div>
<script>
let currentUser = null;
let users = [];
let departments = [];
let editId = null;
function authHeaders(){ const t = localStorage.getItem('token'); return t ? { 'Authorization':'Bearer '+t } : {}; }
async function requireLogin(){
  const stored = localStorage.getItem('user');
  if(stored){ const u = JSON.parse(stored); if(u.role==='admin'||u.role==='superuser'){ currentUser=u; return; } }
  const res = await fetch('/api/me');
  if(res.ok){ const u = await res.json(); localStorage.setItem('user', JSON.stringify(u)); if(u.role==='admin'||u.role==='superuser'){ currentUser=u; return; }}
  localStorage.removeItem('user');
  localStorage.removeItem('token');
  window.location.href = '/login.html';
}
requireLogin();
async function loadDepartments(){
  const res = await fetch('/api/departments', {headers: authHeaders()});
  departments = await res.json();
  const sel = document.getElementById('editDept');
  sel.innerHTML = '<option value=""></option>';
  departments.forEach(d=>{ const o=document.createElement('option'); o.value=d.id; o.textContent=d.name; sel.appendChild(o); });
  const userSel = document.getElementById('userDept');
  if(userSel){
    userSel.innerHTML = '';
    departments.forEach(d=>{ const o=document.createElement('option'); o.value=d.id; o.textContent=d.name; userSel.appendChild(o); });
  }
}
async function loadUsers(){
  const res = await fetch('/api/users', {headers: authHeaders()});
  users = await res.json();
  renderTable();
}
function renderTable(){
  const tbody=document.querySelector('#usersTable tbody');
  tbody.innerHTML='';
  users.forEach(u=>{
    const tr=document.createElement('tr');
    const dept=departments.find(d=>d.id===u.departmentId);
    tr.innerHTML=`<td>${u.username}</td><td>${u.email||''}</td><td>${dept?dept.name:''}</td><td>${u.role}</td>`;
    const editTd=document.createElement('td');
    const editBtn=document.createElement('button');
    editBtn.className='btn btn-sm btn-secondary';
    editBtn.textContent='Edit';
    editBtn.onclick=()=>startEdit(u);
    editTd.appendChild(editBtn);
    const delTd=document.createElement('td');
    const delBtn=document.createElement('button');
    delBtn.className='btn btn-sm btn-danger';
    delBtn.textContent='Delete';
    delBtn.onclick=()=>deleteUser(u.id);
    delTd.appendChild(delBtn);
    tr.appendChild(editTd);
    tr.appendChild(delTd);
    tbody.appendChild(tr);
  });
}
function startEdit(u){
  editId=u.id;
  document.getElementById('editName').value=u.username;
  document.getElementById('editEmail').value=u.email||'';
  document.getElementById('editDept').value=u.departmentId||'';
  document.getElementById('editRole').value=u.role;
  document.getElementById('editPassword').value='';
}

async function deleteUser(id){
  await fetch('/api/users/'+id, {method:'DELETE', headers: authHeaders()});
  loadUsers();
}

document.getElementById('editForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const body={
    username: document.getElementById('editName').value,
    email: document.getElementById('editEmail').value,
    departmentId: document.getElementById('editDept').value,
    role: document.getElementById('editRole').value
  };
  const pwd=document.getElementById('editPassword').value;
  if(pwd) body.password=pwd;
  await fetch('/api/users/'+editId, {method:'PATCH', headers:{'Content-Type':'application/json', ...authHeaders()}, body: JSON.stringify(body)});
  e.target.reset();
  loadUsers();
});

const userForm = document.getElementById('userForm');
if(userForm){
  userForm.addEventListener('submit', async e=>{
    e.preventDefault();
    const body={
      username: document.getElementById('newUsername').value,
      password: document.getElementById('newPassword').value,
      departmentId: document.getElementById('userDept').value,
      role: document.getElementById('userRole').value
    };
    await fetch('/api/users', {method:'POST', headers:{'Content-Type':'application/json', ...authHeaders()}, body: JSON.stringify(body)});
    e.target.reset();
    loadUsers();
  });
}

loadDepartments().then(loadUsers);
</script>
</body>
</html>
