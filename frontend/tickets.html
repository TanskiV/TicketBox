<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title data-i18n="title">Hotel Sharon - TicketBox</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="frontend/style.css" />
  <link rel="icon" type="image/png" href="logo.png" />
  <script src="header.js"></script>
  <script src="utils/notifications.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
  <body>
  <div id="header"></div>
  <div class="container">

  <div class="ticket-form form-section">
    <h2 data-i18n="newTicket">New Ticket</h2>
    <form id="addForm" autocomplete="off">
      <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
        <textarea id="desc" data-i18n-placeholder="description" class="form-control" required></textarea>
        <input type="text" id="room" data-i18n-placeholder="room" class="form-control" required />
        <select id="deptSelect" class="form-select" required></select>
        <button type="submit" class="btn btn-primary btn-sm" data-i18n="addTicket">Add Ticket</button>
      </div>
    </form>
  </div>

  <h2 data-i18n="tickets">Tickets</h2>
  <form id="filterForm" class="d-flex align-items-center gap-2 mb-3" onsubmit="loadTickets(); return false;">
    <input type="text" id="filterRoom" class="form-control" data-i18n-placeholder="filterRoom" autocomplete="off" />
    <button type="submit" class="btn btn-outline-secondary btn-sm" data-i18n="refresh">Refresh</button>
  </form>
  <div id="ticketCards" class="d-md-none"></div>
  <div class="d-none d-md-block">
  <div class="table-responsive">
  <table id="tickets" class="table table-bordered table-sm">
    <thead>
      <tr>
        <th data-i18n="id" data-key="id" class="sortable">ID</th>
        <th data-i18n="description" data-key="description" class="sortable">Description</th>
        <th data-i18n="room" data-key="room" class="sortable">Room</th>
        <th data-i18n="department" data-key="department" class="sortable">Department</th>
        <th data-i18n="photo">Photo</th>
        <th data-i18n="openedBy" data-key="openedBy" class="sortable">Opened by</th>
        <th data-i18n="closedBy" data-key="closedBy" class="sortable">Closed by</th>
        <th data-i18n="openedAt" data-key="openedAt" class="sortable">Opened at</th>
        <th data-i18n="closedAt" data-key="closedAt" class="sortable">Closed at</th>
        <th data-i18n="status" data-key="status" class="sortable">Status</th>
        <th data-i18n="actions">Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  </div>
  </div>

  <div class="mt-4">
    <div class="row g-2 mb-2">
      <div class="col-auto">
        <input type="date" id="fromDate" class="form-control" />
      </div>
      <div class="col-auto">
        <input type="date" id="toDate" class="form-control" />
      </div>
      <div class="col-auto">
        <input type="text" id="closedRoom" class="form-control" data-i18n-placeholder="room" />
      </div>
      <div class="col-auto">
        <button id="showClosed" class="btn btn-secondary" data-i18n="showClosed">Show closed tickets</button>
      </div>
    </div>
    <div class="table-responsive">
      <table id="closedTable" class="table table-bordered table-sm">
        <thead>
          <tr>
            <th>#</th>
            <th data-i18n="room">Room</th>
            <th data-i18n="description">Description</th>
            <th data-i18n="openedAt">Opened at</th>
            <th data-i18n="openedBy">Opened by</th>
            <th data-i18n="closedAt">Closed at</th>
            <th data-i18n="closedBy">Closed by</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
let currentUser = null;
let sortKey = null;
let sortAsc = true;
let editId = null;
function authHeaders(){
  const token = localStorage.getItem('token');
  return token ? { 'Authorization': 'Bearer ' + token } : {};
}
async function requireLogin(){
  const stored = localStorage.getItem('user');
  if(stored){
    currentUser = JSON.parse(stored);
    return;
  }
  const res = await fetch('/api/me');
  if(res.ok){
    currentUser = await res.json();
    localStorage.setItem('user', JSON.stringify(currentUser));
    return;
  }
  localStorage.removeItem('user');
  localStorage.removeItem('token');
  window.location.href = '/login.html';
}
requireLogin();
const translations = {
  en: {
    title: 'Hotel Sharon - TicketBox',
    newTicket: 'New Ticket',
    description: 'Description',
    department: 'Department',
    room: 'Room',
    user: 'User',
    addTicket: 'Add Ticket',
    tickets: 'Tickets',
    filterRoom: 'Filter by room',
    refresh: 'Refresh',
    id: 'ID',
    status: 'Status',
    actions: 'Actions',
    photo: 'Photo',
    openedBy: 'Opened by',
    closedBy: 'Closed by',
    selectDepartment: 'Select Department',
    selectUser: 'Select User',
    manageDepartments: 'Manage Departments',
    manageStaff: 'Manage Staff',
    logout: 'Logout',
    edit: 'Edit',
    save: 'Save',
    showClosed: 'Show closed tickets',
    fromDate: 'From',
    toDate: 'To',
    openStatus: 'Open',
      closedStatus: 'Closed',
      close: 'Close',
      reopen: 'Reopen',
      openedAt: 'Opened at',
      closedAt: 'Closed at',
      noDepartment: 'Not selected',
      editTicket: 'Edit Ticket',
      deleteConfirm: 'Delete this ticket?',
      delete: 'Delete',
      departmentRequired: 'Department required',
      ticketAdded: 'Ticket added successfully!'
    },
    he: {
    title: 'Hotel Sharon - TicketBox',
    newTicket: '\u05EA\u05E7\u05DC\u05D4 \u05D7\u05D3\u05E9\u05D4',
    description: '\u05EA\u05D9\u05D0\u05D5\u05E8',
    department: '\u05DE\u05D7\u05DC\u05E7\u05D4',
    room: '\u05D7\u05D3\u05E8',
    user: '\u05DE\u05E9\u05EA\u05DE\u05E9',
    addTicket: '\u05D4\u05D5\u05E1\u05E3 \u05EA\u05E7\u05DC\u05D4',
    tickets: '\u05E8\u05E9\u05D9\u05DE\u05EA \u05EA\u05E7\u05DC\u05D5\u05EA',
    filterRoom: '\u05E1\u05D9\u05E0\u05D5\u05DF \u05DC\u05E4\u05D9 \u05D7\u05D3\u05E8',
    refresh: '\u05E8\u05E2\u05E0\u05DF',
    id: '\u05DE\u05D6\u05D4\u05D4',
    status: '\u05E1\u05D8\u05D8\u05D5\u05E1',
    actions: '\u05E4\u05E2\u05D5\u05DC\u05D5\u05EA',
    photo: '\u05EA\u05DE\u05D5\u05E0\u05D4',
    openStatus: '\u05E4\u05EA\u05D5\u05D7\u05D4',
      closedStatus: '\u05E1\u05D2\u05D5\u05E8\u05D4',
      close: '\u05E1\u05D2\u05D5\u05E8',
      reopen: '\u05E4\u05EA\u05D5\u05D7 \u05DE\u05D7\u05D3\u05E9',
      openedAt: '\u05EA\u05D0\u05E8\u05D9\u05DA \u05E4\u05EA\u05D9\u05D7\u05D4',
      closedAt: '\u05EA\u05D0\u05E8\u05D9\u05DA \u05E1\u05D2\u05D9\u05E8\u05D4',
      openedBy: '\u05E0\u05E4\u05EA\u05D7 \u05E2\u05DC \u05D9\u05D3\u05D9',
      closedBy: '\u05E0\u05E1\u05D2\u05E8 \u05E2\u05DC \u05D9\u05D3\u05D9',
      selectDepartment: '\u05D1\u05D7\u05E8 \u05DE\u05D7\u05DC\u05E7\u05D4',
      selectUser: '\u05D1\u05D7\u05E8 \u05E2\u05D5\u05D1\u05D3',
      manageDepartments: '\u05E0\u05D9\u05D4\u05D5\u05DC \u05DE\u05D7\u05DC\u05E7\u05D5\u05EA',
      manageStaff: '\u05E0\u05D9\u05D4\u05D5\u05DC \u05E2\u05D5\u05D1\u05D3\u05D9\u05DD',
      logout: '\u05D9\u05E6\u05D9\u05D0\u05D4',
      edit: '\u05E2\u05E8\u05D5\u05DA',
      save: '\u05E9\u05DE\u05D5\u05E8',
      showClosed: '\u05D4\u05E6\u05D2 \u05EA\u05E7\u05DC\u05D5\u05EA \u05E1\u05D2\u05D5\u05E8\u05D5\u05EA',
      fromDate: '\u05DE',
      toDate: '\u05E2\u05D3',
      noDepartment: '\u05DC\u05D0 \u05E0\u05D1\u05D7\u05E8\u05D4',
      editTicket: '\u05E2\u05E8\u05D9\u05DB\u05EA \u05EA\u05E7\u05DC\u05D4',
      deleteConfirm: '\u05DC\u05DE\u05D7\u05D5\u05E7 \u05D0\u05EA \u05D4\u05EA\u05E7\u05DC\u05D4?',
      delete: '\u05DE\u05D7\u05D9\u05E7\u05D4',
      departmentRequired: '\u05DE\u05D7\u05DC\u05E7\u05D4 \u05E0\u05D3\u05E8\u05E9\u05EA',
      ticketAdded: '\u05D4\u05EA\u05E7\u05DC\u05D4 \u05E0\u05D5\u05E1\u05E4\u05D4 \u05D1\u05D4\u05E6\u05DC\u05D7\u05D4!'
    },
    ru: {
    title: 'Hotel Sharon - TicketBox',
    newTicket: '\u041D\u043E\u0432\u0430\u044F \u0437\u0430\u044F\u0432\u043A\u0430',
    description: '\u041E\u043F\u0438\u0441\u0430\u043D\u0438\u0435',
    department: '\u041E\u0442\u0434\u0435\u043B',
    room: '\u041A\u043E\u043C\u043D\u0430\u0442\u0430',
    user: '\u041F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044C',
    addTicket: '\u0414\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0437\u0430\u044F\u0432\u043A\u0443',
    tickets: '\u0417\u0430\u044F\u0432\u043A\u0438',
    filterRoom: '\u0424\u0438\u043B\u044C\u0442\u0440 \u043F\u043E \u043A\u043E\u043C\u043D\u0430\u0442\u0435',
    refresh: '\u041E\u0431\u043D\u043E\u0432\u0438\u0442\u044C',
    id: 'ID',
    status: '\u0421\u0442\u0430\u0442\u0443\u0441',
    actions: '\u0414\u0435\u0439\u0441\u0442\u0432\u0438\u044F',
    photo: '\u0424\u043E\u0442\u043E',
    openedBy: '\u041E\u0442\u043A\u0440\u044B\u043B',
    closedBy: '\u0417\u0430\u043A\u0440\u044B\u043B',
    selectDepartment: '\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u043E\u0442\u0434\u0435\u043B',
    selectUser: '\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F',
    manageDepartments: '\u0423\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u0438\u0435 \u043E\u0442\u0434\u0435\u043B\u0430\u043C\u0438',
    manageStaff: '\u0423\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u0438\u0435 \u043F\u0435\u0440\u0441\u043E\u043D\u0430\u043B\u043E\u043C',
    logout: '\u0412\u044B\u0445\u043E\u0434',
    edit: '\u0420\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C',
    save: '\u0421\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C',
    showClosed: '\u041F\u043E\u043A\u0430\u0437\u0430\u0442\u044C \u0437\u0430\u043A\u0440\u044B\u0442\u044B\u0435',
    fromDate: '\u0441',
    toDate: '\u043F\u043E',
    noDepartment: '\u041D\u0435 \u0432\u044B\u0431\u0440\u0430\u043D\u043E',
    editTicket: '\u0420\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0437\u0430\u044F\u0432\u043A\u0443',
    deleteConfirm: "\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u044d\u0442\u0443 \u0437\u0430\u044F\u0432\u043A\u0443?",
    delete: "\u0423\u0434\u0430\u043B\u0438\u0442\u044C",
    departmentRequired: '\u0422\u0440\u0435\u0431\u0443\u0435\u0442\u0441\u044F \u043E\u0442\u0434\u0435\u043B',
    ticketAdded: '\u0417\u0430\u044F\u0432\u043A\u0430 \u0443\u0441\u043F\u0435\u0448\u043D\u043E \u0434\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u0430!',
    openStatus: '\u041E\u0442\u043A\u0440\u044B\u0442\u0430',
      closedStatus: '\u0417\u0430\u043A\u0440\u044B\u0442\u0430',
      close: '\u0417\u0430\u043A\u0440\u044B\u0442\u044C',
      reopen: '\u041E\u0442\u043A\u0440\u044B\u0442\u044C \u0437\u0430\u043D\u043E\u0432\u043E',
      openedAt: '\u041E\u0442\u043A\u0440\u044B\u0442\u0430 \u0432',
      closedAt: '\u0417\u0430\u043A\u0440\u044B\u0442\u0430 \u0432'
    }
  };

let currentLang = 'en';
let departments = [];

function t(key) {
  return translations[currentLang][key] || key;
}

function applyTranslations() {
  document.querySelectorAll('[data-i18n]').forEach(el => {
    el.textContent = t(el.dataset.i18n);
  });
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
    el.placeholder = t(el.dataset.i18nPlaceholder);
  });
  document.documentElement.lang = currentLang;
  document.documentElement.dir = currentLang === 'he' ? 'rtl' : 'ltr';
}

function setLang(lang) {
  currentLang = lang;
  localStorage.setItem('lang', lang);
  applyTranslations();
  loadTickets();
}

function getLang() {
  const stored = localStorage.getItem('lang');
  if (stored) return stored;
  return navigator.language && navigator.language.startsWith('he') ? 'he' : 'en';
}

function formatDate(str) {
  if (!str) return '';
  const d = new Date(str);
  const day = String(d.getDate()).padStart(2, '0');
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const year = d.getFullYear();
  const hours = String(d.getHours()).padStart(2, '0');
  const minutes = String(d.getMinutes()).padStart(2, '0');
  return `${hours}:${minutes} ${day}/${month}/${year}`;
}


async function loadDepartmentsList() {
  const res = await fetch('/api/departments', { headers: authHeaders() });
  departments = await res.json();
  const select = document.getElementById('deptSelect');
  if (select) {
    select.innerHTML = `<option value="">${t('selectDepartment')}</option>`;
    departments.forEach(d => {
      const opt = document.createElement('option');
      opt.value = d.id;
      opt.textContent = d.name;
      select.appendChild(opt);
    });
  }
  const editSelect = document.getElementById('editDept');
  if (editSelect) {
    editSelect.innerHTML = `<option value="">${t('selectDepartment')}</option>`;
    departments.forEach(d => {
      const opt = document.createElement('option');
      opt.value = d.id;
      opt.textContent = d.name;
      editSelect.appendChild(opt);
    });
  }
  renderDeptList();
}


function renderDeptList() {
  const ul = document.getElementById('deptList');
  if (!ul) return;
  ul.innerHTML = '';
  departments.forEach(d => {
    const li = document.createElement('li');
    li.className = 'list-group-item d-flex justify-content-between align-items-center';
    li.textContent = d.name;
    const del = document.createElement('button');
    del.className = 'btn btn-sm btn-danger';
    del.textContent = 'x';
    del.onclick = async () => {
      await fetch(`/api/departments/${d.id}`, {method:'DELETE', headers: authHeaders()});
      loadTickets();
    };
    li.appendChild(del);
    ul.appendChild(li);
  });
}

function setupSorting() {
  document.querySelectorAll('#tickets th.sortable').forEach(th => {
    th.addEventListener('click', () => {
      const key = th.dataset.key;
      if (sortKey === key) {
        sortAsc = !sortAsc;
      } else {
        sortKey = key;
        sortAsc = true;
      }
      document.querySelectorAll('#tickets th.sortable').forEach(h => h.classList.remove('sorted-asc', 'sorted-desc'));
      th.classList.add(sortAsc ? 'sorted-asc' : 'sorted-desc');
      loadTickets();
    });
  });
}

async function loadTickets() {
  await loadDepartmentsList();
  const room = document.getElementById('filterRoom').value;
  const params = new URLSearchParams();
  params.set('status', 'open');
  if (room) params.set('room', room);
  const res = await fetch('/api/tickets?' + params.toString(), { headers: authHeaders() });
  let data = await res.json();

  const getValue = (ticket) => {
    if (!sortKey) return null;
    if (sortKey === 'department') {
      const dept = departments.find(d => d.id === ticket.departmentId);
      return dept ? dept.name : '';
    }
    if (sortKey === 'status') {
      return ticket.closedAt ? t('closedStatus') : t('openStatus');
    }
    if (sortKey === 'openedAt' || sortKey === 'closedAt') {
      return ticket[sortKey] ? new Date(ticket[sortKey]) : null;
    }
    return ticket[sortKey];
  };

  const sortArr = (arr) => arr.sort((a, b) => {
    const av = getValue(a);
    const bv = getValue(b);
    if (av === bv) return 0;
    if (av === undefined || av === null) return sortAsc ? -1 : 1;
    if (bv === undefined || bv === null) return sortAsc ? 1 : -1;
    if (av > bv) return sortAsc ? 1 : -1;
    if (av < bv) return sortAsc ? -1 : 1;
    return 0;
  });

  let openTickets = data;
  let closedTickets = [];

  if (sortKey) {
    sortArr(openTickets);
    sortArr(closedTickets);
  } else {
    openTickets.sort((a, b) => new Date(b.openedAt) - new Date(a.openedAt));
    closedTickets.sort((a, b) => new Date(b.closedAt) - new Date(a.closedAt));
  }

  data = [...openTickets, ...closedTickets];

  const tbody = document.querySelector('#tickets tbody');
  tbody.innerHTML = '';
  const cardsContainer = document.getElementById('ticketCards');
  if (cardsContainer) cardsContainer.innerHTML = '';
  let closedStarted = false;
  data.forEach(ticket => {
    const tr = document.createElement('tr');
    if (ticket.closedAt && !closedStarted) {
      closedStarted = true;
      tr.classList.add('divider');
    }
    const opened = formatDate(ticket.openedAt);
    const closed = formatDate(ticket.closedAt);
    const dept = departments.find(d => d.id === ticket.departmentId);
    const openedBy = ticket.openedBy;
    const closedBy = ticket.closedBy || '';
    const statusClass = ticket.closedAt ? 'status-closed' : 'status-open';
    const statusText = ticket.closedAt ? t('closedStatus') : t('openStatus');
    const displayId = ticket.ticketNumber || ticket.id;
    tr.innerHTML = `<td data-label="${t('id')}">${displayId}</td>` +
                  `<td data-label="${t('description')}">${ticket.description}</td>` +
                  `<td data-label="${t('room')}">${ticket.room}</td>` +
                  `<td data-label="${t('department')}">${dept ? dept.name : t('noDepartment')}</td>` +
                  `<td data-label="${t('photo')}">${ticket.photoUrl ? '<img src="' + ticket.photoUrl + '" class="photo-thumb" style="max-width:60px">' : ''}</td>` +
                  `<td data-label="${t('openedBy')}">${openedBy}</td>` +
                  `<td data-label="${t('closedBy')}">${closedBy}</td>` +
                  `<td data-label="${t('openedAt')}">${opened}</td>` +
                  `<td data-label="${t('closedAt')}">${closed}</td>` +
                  `<td data-label="${t('status')}" class="${statusClass}">${statusText}</td>`;
    const actionTd = document.createElement('td');
    actionTd.setAttribute('data-label', t('actions'));
    if (!ticket.closedAt) {
      if (currentUser.role === 'admin' || currentUser.role === 'superuser') {
        const editBtn = document.createElement('button');
        editBtn.className = 'btn btn-sm btn-secondary me-1';
        editBtn.textContent = t('edit');
        editBtn.onclick = () => openEdit(ticket);
        actionTd.appendChild(editBtn);
      }
      const closeBtn = document.createElement('button');
      closeBtn.className = 'btn btn-sm btn-danger me-1';
      closeBtn.textContent = t('close');
      closeBtn.onclick = () => closeTicket(ticket.id);
      actionTd.appendChild(closeBtn);
      if (currentUser.role === 'admin' || currentUser.role === 'superuser') {
        const delBtn = document.createElement('button');
        delBtn.className = 'btn btn-sm btn-warning';
        delBtn.textContent = t('delete');
        delBtn.onclick = () => deleteTicket(ticket.id);
        actionTd.appendChild(delBtn);
      }
    }
    tr.appendChild(actionTd);
    tbody.appendChild(tr);

    if (cardsContainer) {
      const card = document.createElement('div');
      card.className = 'card mb-3';
      card.style.fontSize = '0.95rem';
      card.id = `ticket-${ticket.id}`;
      const body = document.createElement('div');
      body.className = 'card-body';
      if (document.documentElement.dir === 'rtl') body.classList.add('text-end');
      const displayId2 = ticket.ticketNumber || ticket.id.slice(-4);
      body.innerHTML =
        `<p><strong>${t('id')}:</strong> ${displayId2}</p>` +
        `<p><strong>${t('description')}:</strong> ${ticket.description}</p>` +
        `<p><strong>${t('room')}:</strong> ${ticket.room}</p>` +
        `<p><strong>${t('department')}:</strong> ${dept ? dept.name : t('noDepartment')}</p>` +
        (ticket.photoUrl ? `<img src="${ticket.photoUrl}" class="img-fluid rounded mb-2">` : '') +
        `<p><strong>${t('openedBy')}:</strong> ${openedBy}</p>` +
        `<p><strong>${t('status')}:</strong> <span class="badge ${ticket.closedAt ? 'bg-secondary' : 'bg-success'}">${statusText}</span></p>`;
      if (!ticket.closedAt) {
        const btnGroup = document.createElement('div');
        btnGroup.className = 'd-flex justify-content-end gap-2';
        const closeBtn = document.createElement('button');
        closeBtn.className = 'btn btn-danger btn-sm';
        closeBtn.textContent = t('close');
        closeBtn.onclick = () => closeTicket(ticket.id);
        btnGroup.appendChild(closeBtn);
        if (currentUser.role === 'admin' || currentUser.role === 'superuser') {
          const editBtn = document.createElement('button');
          editBtn.className = 'btn btn-secondary btn-sm';
          editBtn.textContent = t('edit');
          editBtn.onclick = () => openEdit(ticket);
          const delBtn = document.createElement('button');
          delBtn.className = 'btn btn-warning btn-sm';
          delBtn.textContent = t('delete');
          delBtn.onclick = () => deleteTicket(ticket.id);
          btnGroup.appendChild(editBtn);
          btnGroup.appendChild(delBtn);
        }
        body.appendChild(btnGroup);
      }
      card.appendChild(body);
      cardsContainer.appendChild(card);
    }
  });
}

async function closeTicket(id) {
  const body = { userId: currentUser.username, comment: '' };
  await fetch(`/api/tickets/${id}/close`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', ...authHeaders() },
    body: JSON.stringify(body)
  });
  loadTickets();
}

async function reopenTicket(id) {
  await fetch(`/api/tickets/${id}/reopen`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', ...authHeaders() }
  });
  loadClosedTickets();
  loadTickets();
}

async function deleteTicket(id) {
  if (!confirm(t('deleteConfirm'))) return;
  await fetch(`/api/tickets/${id}`, { method: 'DELETE', headers: authHeaders() });
  loadTickets();
}

async function openEdit(ticket) {
  editId = ticket.id;
  await loadDepartmentsList();
  document.getElementById('editDept').value = ticket.departmentId || '';
  document.getElementById('editDesc').value = ticket.description;
  document.getElementById('editRoom').value = ticket.room;
  bootstrap.Modal.getOrCreateInstance(document.getElementById('editModal')).show();
}

async function loadClosedTickets() {
  const params = new URLSearchParams();
  const room = document.getElementById('closedRoom').value.trim();
  if (room) params.set('room', room);
  const from = document.getElementById('fromDate').value;
  const to = document.getElementById('toDate').value;
  if (from) params.set('from', from);
  if (to) params.set('to', to);
  const res = await fetch('/api/tickets/closed?' + params.toString(), { headers: authHeaders() });
  const data = await res.json();
  const tbody = document.querySelector('#closedTable tbody');
  tbody.innerHTML = '';
  data.forEach((ticket, idx) => {
    const tr = document.createElement('tr');
    const openedBy = ticket.openedBy || 'לא ידוע';
    const closedBy = ticket.closedBy || 'לא ידוע';
    const openDate = formatDate(ticket.openedAt);
    const closeDate = formatDate(ticket.closedAt);
    tr.innerHTML = `<td>${idx + 1}</td>` +
                  `<td>${ticket.room}</td>` +
                  `<td>${ticket.description}</td>` +
                  `<td>${openDate}</td>` +
                  `<td>${openedBy}</td>` +
                  `<td>${closeDate}</td>` +
                  `<td>${closedBy}</td>` +
                  `<td>${(currentUser.role === 'admin' || currentUser.role === 'superuser') ? `<button class="btn btn-warning btn-sm" onclick="reopenTicket('${ticket.id}')">${t('reopen')}</button>` : ''}</td>`;
    tbody.appendChild(tr);
  });
}

document.getElementById('addForm').addEventListener('submit', async e => {
  e.preventDefault();
  if (!currentUser || !currentUser.username) {
    alert('Not logged in');
    return;
  }
  const description = document.getElementById('desc').value.trim();
  const room = document.getElementById('room').value.trim();
  if (!description || !room) {
    alert('Fill all fields');
    return;
  }
  const departmentId = document.getElementById('deptSelect').value;
  if (!departmentId) {
    alert(t('departmentRequired'));
    return;
  }
  const body = { description, room, departmentId, openedBy: currentUser.username };
  console.log('Sending ticket', body);
  try {
    const res = await fetch('/api/tickets', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', ...authHeaders() },
      body: JSON.stringify(body)
    });
    if (!res.ok) {
      const err = await res.json().catch(() => ({ error: 'Server error' }));
      alert(err.error || 'Server error');
      return;
    }
    const saved = await res.json();
    console.log('Ticket saved', saved);
    e.target.reset();
    alert(t('ticketAdded'));
    loadTickets();
  } catch (err) {
    console.log(err);
    alert('Server error');
  }
});

setLang(getLang());
setupSorting();

const deptForm = document.getElementById('deptForm');
if (deptForm) {
  deptForm.addEventListener('submit', async e => {
    e.preventDefault();
    await fetch('/api/departments', {method:'POST', headers:{'Content-Type':'application/json', ...authHeaders()}, body: JSON.stringify({name: document.getElementById('newDept').value})});
    e.target.reset();
    loadTickets();
  });
}

document.getElementById('showClosed').addEventListener('click', loadClosedTickets);
document.getElementById('editForm').addEventListener('submit', async e => {
  e.preventDefault();
  if (!editId) return;
  const body = {
    description: document.getElementById('editDesc').value.trim(),
    room: document.getElementById('editRoom').value.trim(),
    departmentId: document.getElementById('editDept').value
  };
  if (!body.departmentId) { alert(t('departmentRequired')); return; }
  const res = await fetch('/api/tickets/' + editId, { method: 'PATCH', headers: { 'Content-Type': 'application/json', ...authHeaders() }, body: JSON.stringify(body) });
  if (!res.ok) {
    const err = await res.json().catch(() => ({ error: 'Server error' }));
    alert(err.error || 'Server error');
    return;
  }
  bootstrap.Modal.getOrCreateInstance(document.getElementById('editModal')).hide();
  loadTickets();
});

// No staff management or close form required
document.body.addEventListener('click', e => {
  if (e.target.classList.contains('photo-thumb')) {
    document.getElementById('modalImage').src = e.target.src;
    bootstrap.Modal.getOrCreateInstance(document.getElementById('photoModal')).show();
  }
});
</script>
  </div>
  <div class="modal fade" id="photoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-body p-0">
          <img id="modalImage" src="" class="img-fluid w-100" alt="photo">
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="editForm" class="needs-validation" novalidate>
          <div class="modal-header">
            <h5 class="modal-title" data-i18n="editTicket">עריכת תקלה</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="editDesc" class="form-label" data-i18n="description">Description</label>
              <textarea id="editDesc" class="form-control" required></textarea>
            </div>
            <div class="mb-3">
              <label for="editRoom" class="form-label" data-i18n="room">Room</label>
              <input type="text" id="editRoom" class="form-control" required />
            </div>
            <div class="mb-3">
              <label for="editDept" class="form-label" data-i18n="department">Department</label>
              <select id="editDept" class="form-select" required></select>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary" data-i18n="save">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</body>
</html>
