<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title data-i18n="title">Hotel Sharon - TicketBox</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" type="image/png" href="logo.png" />
  <script src="header.js"></script>
  <script src="utils/notifications.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
  <body>
  <div id="header"></div>
  <div class="container">


  <h2 data-i18n="manageDepartments">Manage Departments</h2>
  <div class="panel form-section">
    <form id="deptForm" class="row g-2" autocomplete="off">
      <div class="col">
        <input type="text" id="newDept" class="form-control" autocomplete="off" required />
      </div>
      <div class="col-auto">
        <button type="submit" class="btn btn-primary" data-i18n="add">Add</button>
      </div>
    </form>
    <ul id="deptList" class="list-group mt-2"></ul>
  </div>

  <h2 data-i18n="manageUsers">Manage Users</h2>
  <div class="panel form-section">
    <form id="userForm" class="row g-2 align-items-end" autocomplete="off">
      <div class="col-md-3">
        <input type="text" id="newUsername" data-i18n-placeholder="login" class="form-control" autocomplete="off" required />
      </div>
      <div class="col-md-3">
        <input type="password" id="newPassword" data-i18n-placeholder="password" class="form-control" autocomplete="new-password" required />
      </div>
      <div class="col-md-3">
        <select id="userDept" class="form-select"></select>
      </div>
      <div class="col-md-2">
        <select id="userRole" class="form-select">
          <option value="user">User</option>
          <option value="admin">Admin</option>
          <option value="superuser">Superuser</option>
        </select>
      </div>
      <div class="col-md-1">
        <button type="submit" class="btn btn-primary w-100" data-i18n="add">Add</button>
      </div>
    </form>
    <div class="table-responsive">
      <table id="userList" class="table table-bordered table-sm">
        <thead>
          <tr><th data-i18n="login">Login</th><th data-i18n="role">Role</th><th data-i18n="department">Department</th><th></th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <h2 data-i18n="changePassword">Change Password</h2>
  <div class="panel form-section">
    <h3 data-i18n="changePassword">Change Password</h3>
    <form id="passwordForm" class="row g-2" autocomplete="off">
      <div class="col-md-4">
        <select id="passwordUser" class="form-select"></select>
      </div>
      <div class="col-md-4">
        <input type="password" id="adminPassword" class="form-control" data-i18n-placeholder="newPassword" autocomplete="new-password" required />
      </div>
      <div class="col-md-4">
        <button type="submit" class="btn btn-primary w-100" data-i18n="change">Change</button>
      </div>
    </form>
  </div>


  <h2 data-i18n="manageNews">News</h2>
  <div class="panel form-section">
    <form id="newsForm" class="mb-3" enctype="multipart/form-data">
      <div class="mb-2">
        <input type="text" id="newsTitle" class="form-control" data-i18n-placeholder="newsTitle" required />
      </div>
      <div class="mb-2">
        <textarea id="newsContent" class="form-control" rows="3" data-i18n-placeholder="newsContent" required></textarea>
      </div>
      <input type="file" id="newsImage" name="image" accept="image/*" class="form-control mb-3">
      <button type="submit" class="btn btn-primary" data-i18n="publish">Publish</button>
    </form>
    <ul id="newsList" class="list-group"></ul>
  </div>

<script>
let currentUser = null;
function authHeaders(){
  const token = localStorage.getItem('token');
  return token ? { 'Authorization': 'Bearer ' + token } : {};
}
async function requireLogin(){
  const stored = localStorage.getItem('user');
  let u = null;
  if(stored){
    u = JSON.parse(stored);
  } else {
    const res = await fetch('/api/me');
    if(res.ok){
      u = await res.json();
      localStorage.setItem('user', JSON.stringify(u));
    }
  }
  if(!u){
    localStorage.removeItem('user');
    localStorage.removeItem('token');
    window.location.href = '/login.html';
    return;
  }
  if(u.role !== 'admin'){
    localStorage.removeItem('user');
    localStorage.removeItem('token');
    window.location.href = '/index.html';
    return;
  }
  currentUser = u;
}
requireLogin();
const translations = {
  en: {
    title: 'Hotel Sharon - TicketBox',
    newTicket: 'New Ticket',
    description: 'Description',
    department: 'Department',
    room: 'Room',
    user: 'User',
    add: 'Add',
    tickets: 'Tickets',
    filterRoom: 'Filter by room',
    refresh: 'Refresh',
    id: 'ID',
    status: 'Status',
    actions: 'Actions',
    openedBy: 'Opened by',
    closedBy: 'Closed by',
    selectDepartment: 'Select Department',
    selectUser: 'Select User',
    manageDepartments: 'Manage Departments',
    manageUsers: 'Manage Users',
    login: 'Login',
    password: 'Password',
    newPassword: 'New Password',
    role: 'Role',
    changePassword: 'Change Password',
    logout: 'Logout',
    change: 'Change',
    downloadBackup: 'Download Backup',
    uploadBackup: 'Upload Backup',
    manageNews: 'News',
    newsTitle: 'Title',
    newsContent: 'Content',
    publish: 'Publish',
    deleteNewsConfirm: 'Delete this news?',
    deleteConfirm: 'Delete this ticket?',
    delete: 'Delete',
    openStatus: 'Open',
      closedStatus: 'Closed',
      close: 'Close',
      openedAt: 'Opened at',
      closedAt: 'Closed at'
    },
    he: {
    title: 'Hotel Sharon - TicketBox',
    newTicket: '\u05EA\u05E7\u05DC\u05D4 \u05D7\u05D3\u05E9\u05D4',
    description: '\u05EA\u05D9\u05D0\u05D5\u05E8',
    department: '\u05DE\u05D7\u05DC\u05E7\u05D4',
    room: '\u05D7\u05D3\u05E8',
    user: '\u05DE\u05E9\u05EA\u05DE\u05E9',
    add: '\u05D4\u05D5\u05E1\u05E3',
    tickets: '\u05E8\u05E9\u05D9\u05DE\u05EA \u05EA\u05E7\u05DC\u05D5\u05EA',
    filterRoom: '\u05E1\u05D9\u05E0\u05D5\u05DF \u05DC\u05E4\u05D9 \u05D7\u05D3\u05E8',
    refresh: '\u05E8\u05E2\u05E0\u05DF',
    id: '\u05DE\u05D6\u05D4\u05D4',
    status: '\u05E1\u05D8\u05D8\u05D5\u05E1',
    actions: '\u05E4\u05E2\u05D5\u05DC\u05D5\u05EA',
    openStatus: '\u05E4\u05EA\u05D5\u05D7\u05D4',
      closedStatus: '\u05E1\u05D2\u05D5\u05E8\u05D4',
      close: '\u05E1\u05D2\u05D5\u05E8',
      openedAt: '\u05EA\u05D0\u05E8\u05D9\u05DA \u05E4\u05EA\u05D9\u05D7\u05D4',
      closedAt: '\u05EA\u05D0\u05E8\u05D9\u05DA \u05E1\u05D2\u05D9\u05E8\u05D4',
      openedBy: '\u05E0\u05E4\u05EA\u05D7 \u05E2\u05DC \u05D9\u05D3\u05D9',
      closedBy: '\u05E0\u05E1\u05D2\u05E8 \u05E2\u05DC \u05D9\u05D3\u05D9',
      selectDepartment: '\u05D1\u05D7\u05E8 \u05DE\u05D7\u05DC\u05E7\u05D4',
      selectUser: '\u05D1\u05D7\u05E8 \u05E2\u05D5\u05D1\u05D3',
      manageDepartments: '\u05E0\u05D9\u05D4\u05D5\u05DC \u05DE\u05D7\u05DC\u05E7\u05D5\u05EA',
      manageUsers: '\u05E0\u05D9\u05D4\u05D5\u05DC \u05DE\u05E9\u05EA\u05DE\u05E9\u05D9\u05DD',
      login: '\u05E9\u05DD \u05DE\u05E9\u05EA\u05DE\u05E9',
      password: '\u05E1\u05D9\u05E1\u05DE\u05D4',
      newPassword: '\u05E1\u05D9\u05E1\u05DE\u05D4 \u05D7\u05D3\u05E9\u05D4',
      role: '\u05EA\u05E4\u05E7\u05D9\u05D3',
      changePassword: '\u05E9\u05D9\u05E0\u05D5\u05D9 \u05E1\u05D9\u05E1\u05DE\u05D4',
      logout: '\u05D9\u05E6\u05D9\u05D0\u05D4',
      change: '\u05E9\u05E0\u05D4',
      downloadBackup: '\u05D4\u05D5\u05E8\u05D3 \u05D2\u05D9\u05D1\u05D5\u05D9',
      uploadBackup: '\u05D4\u05E2\u05DC\u05D4 \u05D2\u05D9\u05D1\u05D5\u05D9',
      manageNews: '\u05D7\u05D3\u05E9\u05D5\u05EA',
      newsTitle: '\u05DB\u05D5\u05EA\u05E8\u05EA',
      newsContent: '\u05EA\u05D5\u05DB\u05DF',
      publish: '\u05E4\u05E8\u05E1\u05DD',
      deleteNewsConfirm: '\u05DC\u05DE\u05D7\u05D5\u05E7 \u05D0\u05EA \u05D4\u05D9\u05D3\u05E2\u05D4?',
      deleteConfirm: '\u05DC\u05DE\u05D7\u05D5\u05E7 \u05D0\u05EA \u05D4\u05EA\u05E7\u05DC\u05D4?',
      delete: '\u05DE\u05D7\u05D9\u05E7\u05D4'
    },
    ru: {
    title: 'Hotel Sharon - TicketBox',
    newTicket: '\u041D\u043E\u0432\u0430\u044F \u0437\u0430\u044F\u0432\u043A\u0430',
    description: '\u041E\u043F\u0438\u0441\u0430\u043D\u0438\u0435',
    department: '\u041E\u0442\u0434\u0435\u043B',
    room: '\u041A\u043E\u043C\u043D\u0430\u0442\u0430',
    user: '\u041F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044C',
    add: '\u0414\u043E\u0431\u0430\u0432\u0438\u0442\u044C',
    tickets: '\u0417\u0430\u044F\u0432\u043A\u0438',
    filterRoom: '\u0424\u0438\u043B\u044C\u0442\u0440 \u043F\u043E \u043A\u043E\u043C\u043D\u0430\u0442\u0435',
    refresh: '\u041E\u0431\u043D\u043E\u0432\u0438\u0442\u044C',
    id: 'ID',
    status: '\u0421\u0442\u0430\u0442\u0443\u0441',
    actions: '\u0414\u0435\u0439\u0441\u0442\u0432\u0438\u044F',
    openedBy: '\u041E\u0442\u043A\u0440\u044B\u043B',
    closedBy: '\u0417\u0430\u043A\u0440\u044B\u043B',
    selectDepartment: '\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u043E\u0442\u0434\u0435\u043B',
    selectUser: '\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F',
    manageDepartments: '\u0423\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u0438\u0435 \u043E\u0442\u0434\u0435\u043B\u0430\u043C\u0438',
    manageUsers: '\u0423\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u0438\u0435 \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F\u043C\u0438',
    login: '\u041B\u043E\u0433\u0438\u043D',
    password: '\u041F\u0430\u0440\u043E\u043B\u044C',
    newPassword: '\u041D\u043E\u0432\u044B\u0439 \u043F\u0430\u0440\u043E\u043B\u044C',
    role: '\u0420\u043E\u043B\u044C',
    changePassword: '\u0421\u043C\u0435\u043D\u0438\u0442\u044C \u043F\u0430\u0440\u043E\u043B\u044C',
    logout: '\u0412\u044B\u0445\u043E\u0434',
    change: '\u0418\u0437\u043C\u0435\u043D\u0438\u0442\u044C',
    downloadBackup: '\u0421\u043A\u0430\u0447\u0430\u0442\u044C \u0440\u0435\u0437\u0435\u0440\u0432',
    uploadBackup: '\u0417\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0440\u0435\u0437\u0435\u0440\u0432',
    manageNews: '\u041D\u043E\u0432\u043E\u0441\u0442\u0438',
    newsTitle: '\u0417\u0430\u0433\u043E\u043B\u043E\u0432\u043E\u043A',
    newsContent: '\u0422\u0435\u043A\u0441\u0442',
    publish: '\u041E\u043F\u0443\u0431\u043B\u0438\u043A\u043E\u0432\u0430\u0442\u044C',
    deleteNewsConfirm: '\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u043D\u043E\u0432\u043E\u0441\u0442\u044C?',
    deleteConfirm: '\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u044D\u0442\u0443 \u0437\u0430\u044F\u0432\u043A\u0443?',
    delete: '\u0423\u0434\u0430\u043B\u0438\u0442\u044C',
    openStatus: '\u041E\u0442\u043A\u0440\u044B\u0442\u0430',
      closedStatus: '\u0417\u0430\u043A\u0440\u044B\u0442\u0430',
      close: '\u0417\u0430\u043A\u0440\u044B\u0442\u044C',
      openedAt: '\u041E\u0442\u043A\u0440\u044B\u0442\u0430 \u0432',
      closedAt: '\u0417\u0430\u043A\u0440\u044B\u0442\u0430 \u0432'
    }
  };

let currentLang = 'en';
let departments = [];
let t = translations[currentLang];

function applyTranslations() {
  document.querySelectorAll('[data-i18n]').forEach(el => {
    el.textContent = t[el.dataset.i18n];
  });
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
    el.placeholder = t[el.dataset.i18nPlaceholder];
  });
  document.documentElement.lang = currentLang;
  document.documentElement.dir = currentLang === 'he' ? 'rtl' : 'ltr';
}

function setLang(lang) {
  currentLang = lang;
  localStorage.setItem('lang', lang);
  t = translations[currentLang];
  applyTranslations();
  refreshDepartments();
}

function getLang() {
  const stored = localStorage.getItem('lang');
  if (stored) return stored;
  return navigator.language && navigator.language.startsWith('he') ? 'he' : 'en';
}


async function loadDepartmentsList() {
  const res = await fetch('/api/departments', { headers: authHeaders() });
  departments = await res.json();
  const select = document.getElementById('deptSelect');
  if (select) {
    select.innerHTML = `<option value="">${t.selectDepartment}</option>`;
    departments.forEach(d => {
      const opt = document.createElement('option');
      opt.value = d.id;
      opt.textContent = d.name;
      select.appendChild(opt);
    });
  }
  renderDeptList();
}

async function refreshDepartments() {
  await loadDepartmentsList();
  loadUsersList();
}


function renderDeptList() {
  const ul = document.getElementById('deptList');
  if (!ul) return;
  ul.innerHTML = '';
  departments.forEach(d => {
    const li = document.createElement('li');
    li.className = 'list-group-item d-flex justify-content-between align-items-center';
    li.textContent = d.name;
    const del = document.createElement('button');
    del.className = 'btn btn-sm btn-danger';
    del.textContent = 'x';
    del.onclick = async () => {
      await fetch(`/api/departments/${d.id}`, {method:'DELETE', headers: authHeaders()});
      refreshDepartments();
    };
    li.appendChild(del);
    ul.appendChild(li);
  });
}

let users = [];

async function loadUsersList() {
  const res = await fetch('/api/users', { headers: authHeaders() });
  users = await res.json();
  const deptSel = document.getElementById('userDept');
  if (deptSel) {
    deptSel.innerHTML = '';
    departments.forEach(d => {
      const opt = document.createElement('option');
      opt.value = d.id;
      opt.textContent = d.name;
      deptSel.appendChild(opt);
    });
  }
  const userSel = document.getElementById('passwordUser');
  if (userSel) {
    userSel.innerHTML = '';
    users.forEach(u => {
      const opt = document.createElement('option');
      opt.value = u.id;
      opt.textContent = u.username;
      userSel.appendChild(opt);
    });
  }
  renderUserList();
}

function renderUserList() {
  const tbody = document.querySelector('#userList tbody');
  if (!tbody) return;
  tbody.innerHTML = '';
  users.forEach(u => {
    const tr = document.createElement('tr');
    const dept = departments.find(d => d.id === u.departmentId);
    tr.innerHTML = `<td>${u.username}</td><td>${u.role}</td><td>${dept ? dept.name : ''}</td>`;
    const td = document.createElement('td');
    const del = document.createElement('button');
    del.className = 'btn btn-sm btn-danger';
    del.textContent = 'x';
    del.onclick = async () => {
      await fetch(`/api/users/${u.id}`, {method:'DELETE', headers: authHeaders()});
      loadUsersList();
    };
    td.appendChild(del);
    tr.appendChild(td);
    tbody.appendChild(tr);
  });
}

setLang(getLang());
loadUsersList();

document.getElementById('deptForm').addEventListener('submit', async e => {
  e.preventDefault();
  await fetch('/api/departments', {method:'POST', headers:{'Content-Type':'application/json', ...authHeaders()}, body: JSON.stringify({name: document.getElementById('newDept').value})});
  e.target.reset();
  refreshDepartments();
});

const userForm = document.getElementById('userForm');
if (userForm) {
  userForm.addEventListener('submit', async e => {
    e.preventDefault();
    const body = {
      username: document.getElementById('newUsername').value,
      password: document.getElementById('newPassword').value,
      departmentId: document.getElementById('userDept').value,
      role: document.getElementById('userRole').value
    };
    await fetch('/api/users', {method:'POST', headers:{'Content-Type':'application/json', ...authHeaders()}, body: JSON.stringify(body)});
    e.target.reset();
    loadUsersList();
  });
}

const passwordForm = document.getElementById('passwordForm');
if (passwordForm) {
  passwordForm.addEventListener('submit', async e => {
    e.preventDefault();
    const userId = document.getElementById('passwordUser').value;
    const pwd = document.getElementById('adminPassword').value;
    if (!userId) return;
    await fetch(`/api/users/${userId}/password`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json', ...authHeaders()},
      body: JSON.stringify({ password: pwd })
    });
    const u = users.find(u => u.id === userId);
    alert(`Password for user ${u ? u.username : userId} updated successfully`);
    e.target.reset();
  });
}

let newsData = [];

async function loadNewsList() {
  const res = await fetch('/api/news', { headers: authHeaders() });
  if (!res.ok) return;
  newsData = await res.json();
  renderNewsList();
}

function renderNewsList() {
  const list = document.getElementById('newsList');
  if (!list) return;
  list.innerHTML = '';
  newsData.forEach(n => {
    const li = document.createElement('li');
    li.className = 'list-group-item d-flex justify-content-between align-items-start';
    const div = document.createElement('div');
    div.className = 'me-2';
    div.innerHTML = `<strong>${n.title}</strong><div>${n.content}</div>`;
    if(n.imageUrl){
      const img = document.createElement('img');
      img.src = n.imageUrl;
      img.alt = 'News image';
      img.className = 'img-fluid rounded mb-2';
      div.appendChild(img);
    }
    li.appendChild(div);
    const del = document.createElement('button');
    del.className = 'btn btn-sm btn-danger';
    del.textContent = tTranslate('delete');
    del.onclick = async () => {
      if (!confirm(tTranslate('deleteNewsConfirm'))) return;
      await fetch('/api/news/' + (n.id || n._id), { method: 'DELETE', headers: authHeaders() });
      loadNewsList();
    };
    li.appendChild(del);
    list.appendChild(li);
  });
}

document.getElementById('newsForm').addEventListener('submit', async e => {
  e.preventDefault();
  const fd = new FormData();
  fd.append('title', document.getElementById('newsTitle').value.trim());
  fd.append('content', document.getElementById('newsContent').value.trim());
  const file = document.getElementById('newsImage').files[0];
  if(file) fd.append('image', file);
  const res = await fetch('/api/news', { method: 'POST', headers: authHeaders(), body: fd });
  if (res.ok) {
    e.target.reset();
    loadNewsList();
  } else {
    const err = await res.json().catch(() => ({ error: 'Error' }));
    alert(err.error);
  }
});

function tTranslate(key) { return t[key]; }

loadNewsList();

</script>
</div>
</body>
</html>
