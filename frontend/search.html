<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Search Tickets</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" type="image/png" href="logo.png" />
  <script src="header.js"></script>
  <script src="utils/notifications.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
<div id="header"></div>
<div class="container mt-3">
  <h2>Search Tickets</h2>
  <form id="searchForm" class="row g-2 mb-3">
    <div class="col-md-2"><input type="date" id="openFrom" class="form-control" placeholder="Open from"></div>
    <div class="col-md-2"><input type="date" id="openTo" class="form-control" placeholder="Open to"></div>
    <div class="col-md-2"><input type="date" id="closeFrom" class="form-control" placeholder="Close from"></div>
    <div class="col-md-2"><input type="date" id="closeTo" class="form-control" placeholder="Close to"></div>
    <div class="col-md-2"><input type="text" id="room" class="form-control" placeholder="Room"></div>
    <div class="col-md-2">
      <select id="status" class="form-select">
        <option value="">All</option>
        <option value="open">Open</option>
        <option value="closed">Closed</option>
        <option value="inprogress">In Process</option>
      </select>
    </div>
    <div class="col-md-2"><input type="text" id="openedBy" class="form-control" placeholder="Opened by"></div>
    <div class="col-md-2"><input type="text" id="closedBy" class="form-control" placeholder="Closed by"></div>
    <div class="col-md-2"><select id="department" class="form-select"></select></div>
    <div class="col-md-2"><input type="text" id="keyword" class="form-control" placeholder="Keyword"></div>
    <div class="col-md-2"><button type="submit" class="btn btn-primary w-100">Search</button></div>
  </form>
  <div class="table-responsive">
    <table id="results" class="table table-bordered table-sm">
      <thead>
        <tr>
          <th>#</th>
          <th>Description</th>
          <th>Room</th>
          <th>Department</th>
          <th>Opened by</th>
          <th>Closed by</th>
          <th>Opened at</th>
          <th>Closed at</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>
<script>
let currentUser = null;
let departments = [];
function authHeaders(){
  const token = localStorage.getItem('token');
  return token ? { 'Authorization': 'Bearer ' + token } : {};
}
async function requireLogin(){
  const stored = localStorage.getItem('user');
  if(stored){ const u = JSON.parse(stored); if(u.role==='admin'||u.role==='superuser'){ currentUser=u; return; } }
  const res = await fetch('/api/me');
  if(res.ok){ const u = await res.json(); localStorage.setItem('user', JSON.stringify(u)); if(u.role==='admin'||u.role==='superuser'){ currentUser=u; return; }}
  localStorage.removeItem('user');
  localStorage.removeItem('token');
  window.location.href = '/login.html';
}
requireLogin();
async function loadDepartments(){
  const res = await fetch('/api/departments', {headers: authHeaders()});
  departments = await res.json();
  const sel = document.getElementById('department');
  sel.innerHTML = '<option value="">All</option>';
  departments.forEach(d=>{ const o=document.createElement('option'); o.value=d.id; o.textContent=d.name; sel.appendChild(o); });
}
function formatDate(str){
  if(!str) return '';
  const d = new Date(str);
  return d.toLocaleString();
}
async function searchTickets(){
  const params = new URLSearchParams();
  const of=document.getElementById('openFrom').value; if(of) params.set('openFrom', of);
  const ot=document.getElementById('openTo').value; if(ot) params.set('openTo', ot);
  const cf=document.getElementById('closeFrom').value; if(cf) params.set('closeFrom', cf);
  const ct=document.getElementById('closeTo').value; if(ct) params.set('closeTo', ct);
  const room=document.getElementById('room').value.trim(); if(room) params.set('room', room);
  const status=document.getElementById('status').value; if(status) params.set('status', status);
  const openedBy=document.getElementById('openedBy').value.trim(); if(openedBy) params.set('openedBy', openedBy);
  const closedBy=document.getElementById('closedBy').value.trim(); if(closedBy) params.set('closedBy', closedBy);
  const dept=document.getElementById('department').value; if(dept) params.set('departmentId', dept);
  const kw=document.getElementById('keyword').value.trim(); if(kw) params.set('keyword', kw);
  const res = await fetch('/api/tickets/search?'+params.toString(), {headers: authHeaders()});
  const data = await res.json();
  const tbody=document.querySelector('#results tbody');
  tbody.innerHTML='';
  data.forEach((t,idx)=>{
    const dept=departments.find(d=>d.id===t.departmentId);
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${idx+1}</td><td>${t.description}</td><td>${t.room}</td><td>${dept?dept.name:''}</td><td>${t.openedBy||''}</td><td>${t.closedBy||''}</td><td>${formatDate(t.openedAt)}</td><td>${formatDate(t.closedAt)}</td><td>${t.isClosed?'Closed':'Open'}</td>`;
    tbody.appendChild(tr);
  });
}
document.getElementById('searchForm').addEventListener('submit', e=>{e.preventDefault(); searchTickets();});
loadDepartments();
</script>
</body>
</html>
