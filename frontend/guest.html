<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title data-i18n="title">Report Issue</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" type="image/png" href="logo.png" />
  <script src="header.js"></script>
  <script src="utils/notifications.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
  <body>
  <div id="header"></div>
  <div class="container mt-4">
    <div class="card shadow">
      <div class="card-header">פתיחת תקלה לאורחים</div>
      <div class="card-body">
        <form id="guestForm" class="ticket-form" autocomplete="off" novalidate>
          <div class="mb-3">
            <label for="room" class="form-label" data-i18n="room">Room</label>
            <input type="text" id="room" class="form-control" data-i18n-placeholder="room" required />
            <div class="invalid-feedback" data-i18n="roomRequired">Room is required</div>
          </div>
          <div class="mb-3">
            <label for="desc" class="form-label" data-i18n="description">Description</label>
            <textarea id="desc" class="form-control" data-i18n-placeholder="description" required></textarea>
            <div class="invalid-feedback">Required</div>
          </div>
          <div class="mb-3">
            <label for="dept" class="form-label" data-i18n="department">Department</label>
            <select id="dept" class="form-select" required></select>
            <div class="invalid-feedback">Required</div>
          </div>
          <div class="mb-3">
            <label for="photo" class="form-label">Photo</label>
            <input type="file" id="photo" class="form-control" accept="image/*" />
          </div>
          <button type="submit" class="btn btn-primary submit-button" data-i18n="submit">Submit</button>
        </form>
        <div id="success" class="alert alert-success mt-3 d-none" role="alert"></div>
      </div>
    </div>
  </div>
  <script>
    const translations = {
      en: {
        title: 'Report Issue',
        heading: 'Report an Issue',
        room: 'Room',
        description: 'Description',
        submit: 'Submit',
        roomRequired: 'Room is required',
        selectDepartment: 'Select Department',
        department: 'Department',
        success: 'Thank you! Your ticket has been received.',
        serverError: 'Server error'
      },
      he: {
        title: '\u05D3\u05D5\u05D7 \u05EA\u05E7\u05DC\u05D4',
        heading: '\u05D3\u05D5\u05D7 \u05E2\u05DC \u05EA\u05E7\u05DC\u05D4',
        room: '\u05D7\u05D3\u05E8',
        description: '\u05EA\u05D9\u05D0\u05D5\u05E8',
        submit: '\u05E9\u05DC\u05D7',
        roomRequired: '\u05D7\u05D5\u05D1\u05D4 \u05DC\u05E6\u05D9\u05D9\u05DF \u05D7\u05D3\u05E8',
        selectDepartment: '\u05D1\u05D7\u05E8 \u05DE\u05D7\u05DC\u05E7\u05D4',
        department: '\u05DE\u05D7\u05DC\u05E7\u05D4',
        success: '\u05EA\u05D5\u05D3\u05D4! \u05D4\u05E4\u05E0\u05D9\u05D9\u05D4 \u05E0\u05E7\u05DC\u05D4.',
        serverError: '\u05E9\u05D2\u05D9\u05D0\u05EA \u05E9\u05E8\u05EA'
      },
      ru: {
        title: '\u0421\u043E\u043E\u0431\u0449\u0438\u0442\u044C \u043E \u043F\u0440\u043E\u0431\u043B\u0435\u043C\u0435',
        heading: '\u0421\u043E\u043E\u0431\u0449\u0438\u0442\u044C \u043E \u043F\u0440\u043E\u0431\u043B\u0435\u043C\u0435',
        room: '\u041A\u043E\u043C\u043D\u0430\u0442\u0430',
        description: '\u041E\u043F\u0438\u0441\u0430\u043D\u0438\u0435',
        submit: '\u041E\u0442\u043F\u0440\u0430\u0432\u0438\u0442\u044C',
        roomRequired: '\u0422\u0440\u0435\u0431\u0443\u0435\u0442\u0441\u044F \u043D\u043E\u043C\u0435\u0440 \u043A\u043E\u043C\u043D\u0430\u0442\u044B',
        selectDepartment: '\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u043E\u0442\u0434\u0435\u043B',
        department: '\u041E\u0442\u0434\u0435\u043B',
        success: '\u0421\u043F\u0430\u0441\u0438\u0431\u043E! \u0412\u0430\u0448\u0430 \u0437\u0430\u044F\u0432\u043A\u0430 \u043F\u043E\u043B\u0443\u0447\u0435\u043D\u0430.',
        serverError: '\u041E\u0448\u0438\u0431\u043A\u0430 \u0441\u0435\u0440\u0432\u0435\u0440\u0430'
      }
    };

    const deptMap = {
      'Maintenance': { en: 'Maintenance', he: '\u05EA\u05D7\u05D6\u05D5\u05E7\u05D4', ru: '\u0422\u0435\u0445\u043D\u0438\u0447\u0435\u0441\u043A\u0438\u0439 \u043E\u0442\u0434\u0435\u043B' },
      'Reception': { en: 'Reception', he: '\u05E7\u05D1\u05DC\u05D4', ru: '\u0420\u0435\u0441\u0435\u043F\u0448\u043D' },
      'Security': { en: 'Security', he: '\u05D0\u05D1\u05D8\u05D7\u05D4', ru: '\u0411\u0435\u0437\u043E\u043F\u0430\u0441\u043D\u043E\u0441\u0442\u044C' },
      'General Management': { en: 'General Management', he: '\u05E0\u05D9\u05D4\u05D5\u05DC \u05DB\u05DC\u05DC\u05D9', ru: '\u0423\u043F\u0440\u0430\u0432\u043B\u044F\u044E\u0449\u0438\u0439' }
    };

    let currentLang = 'en';
    let t = translations[currentLang];
    function applyTranslations(){
      document.querySelectorAll('[data-i18n]').forEach(el=>{ el.textContent = t[el.dataset.i18n]; });
      document.querySelectorAll('[data-i18n-placeholder]').forEach(el=>{ el.placeholder = t[el.dataset.i18nPlaceholder]; });
      document.documentElement.lang = currentLang;
      document.documentElement.dir = currentLang === 'he' ? 'rtl' : 'ltr';
    }
    function setLang(lang){
      currentLang = lang;
      localStorage.setItem('lang', lang);
      t = translations[currentLang];
      applyTranslations();
      loadDepts();
    }
    function getLang(){ const s = localStorage.getItem('lang'); if(s) return s; return navigator.language && navigator.language.startsWith('he') ? 'he' : 'en'; }

    setLang(getLang());

    async function loadDepts(){
      const res = await fetch('/api/departments');
      const list = await res.json();
      const sel = document.getElementById('dept');
      sel.innerHTML = '<option value="">'+t.selectDepartment+'</option>';
      list.forEach(d=>{
        const o=document.createElement('option');
        o.value=d.id;
        const map = deptMap[d.name];
        o.textContent = map ? (map[currentLang] || map.en) : d.name;
        sel.appendChild(o);
      });
    }

    document.getElementById('guestForm').addEventListener('submit', async e => {
      e.preventDefault();
      const roomEl = document.getElementById('room');
      const descEl = document.getElementById('desc');
      const deptEl = document.getElementById('dept');
      let valid = true;
      if(!roomEl.value.trim()){ roomEl.classList.add('is-invalid'); valid=false; } else roomEl.classList.remove('is-invalid');
      if(!descEl.value.trim()){ descEl.classList.add('is-invalid'); valid=false; } else descEl.classList.remove('is-invalid');
      if(!deptEl.value){ deptEl.classList.add('is-invalid'); valid=false; } else deptEl.classList.remove('is-invalid');
      if(!valid) return;
      const fd = new FormData();
      fd.append('room', roomEl.value.trim());
      fd.append('description', descEl.value.trim());
      fd.append('departmentId', deptEl.value);
      const file = document.getElementById('photo').files[0];
      if (file) fd.append('photo', file);
      const res = await fetch('/api/public-ticket', { method: 'POST', body: fd });
      const msg = document.getElementById('success');
      if (res.ok) {
        msg.textContent = t.success;
        msg.classList.remove('d-none');
        e.target.reset();
      } else {
        const err = await res.json().catch(() => ({ error: t.serverError }));
        msg.textContent = err.error || t.serverError;
        msg.classList.remove('d-none');
        msg.classList.replace('alert-success','alert-danger');
      }
    });

    loadDepts();
  </script>
</body>
</html>
